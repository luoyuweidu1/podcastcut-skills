<!--
input: 按静音分隔的句子列表
output: 句内重复索引列表
pos: 规则，建议删优先级

架构守护者：一旦我被修改，请同步更新：
1. 所属文件夹的 README.md
-->

# 句内重复检测

## 定义

同一句内，短语 A 重复出现。分两种模式：单词级和短语级。

## 模式一：单词级（A + 中间字 + A）

```
A + 中间字(1-3字) + A
```

### 案例

| 原文 | 模式 | 删除 |
|------|------|------|
| 所以小所以 | 所以+小+所以 | "所以小" |
| 然后就会然后 | 然后+就会+然后 | "然后就会" |
| 任务3任务3 | 任务3+任务3 | 第一个 |
| 什么关系什么 | 什么+关系+什么 | "什么关系" |

## 模式二：短语级重复（重点！易遗漏）

**定义**：≥4字的短语在同一句内出现两次，中间夹杂少量修正/犹豫词。

```
短语A + 犹豫/修正词 + 短语A（可能略有变化）
```

### 检测逻辑

```javascript
// 在句子全文中找 ≥4字 的重复子串
// 两次出现之间的间隔 ≤ 原短语长度的2倍
function findPhraseRepeats(sentenceText) {
  for (let len = 4; len <= sentenceText.length / 2; len++) {
    for (let i = 0; i <= sentenceText.length - len; i++) {
      const phrase = sentenceText.slice(i, i + len);
      const nextPos = sentenceText.indexOf(phrase, i + len);
      if (nextPos >= 0 && (nextPos - i - len) <= len * 2) {
        // 找到短语级重复，删除从第一次出现到第二次出现之前
        return { deleteFrom: i, deleteTo: nextPos };
      }
    }
  }
}
```

### 案例

| 原文 | 重复短语 | 删除 |
|------|---------|------|
| 和大家都很关心的，很，和大家都很关心的，经常发生的 | "和大家都很关心的" | "和大家都很关心的，很，" |
| 放到台面来说，放放到台面上来说 | "放到台面" | "放到台面来说，放" |
| 我觉得这个事情，嗯，我觉得这个事情挺重要 | "我觉得这个事情" | "我觉得这个事情，嗯，" |

### 关键区别

单词级重复：A 是 1-2 个词（"所以"、"然后"），中间 1-3 字
短语级重复：A 是 ≥4 字短语（"和大家都很关心的"），中间可以更长

**短语级更难检测但更影响听感**，优先级应高于单词级。

## 不是口误

| 原文 | 原因 |
|------|------|
| 任务1任务2任务3 | 列举 |
| to do | 英文 |
| 一个一个地 | 强调 |
| 越来越好，越来越强 | 递进修辞 |
| 开开心心、高高兴兴 | AABB 式叠词，正常表达 |
| 慢慢地、轻轻地、好好的 | AAB 式叠词，正常表达 |
| 妈妈、宝宝、谢谢、哈哈哈 | AA 式叠词/拟声词（详见 5-卡顿词 叠词排除规则） |

## 删除策略：只删一个副本（极重要！）

> **数据来源**：2026-03-01 反馈，S79"这条路这条路"、S415"蛮多的蛮多的" 两个 restore 原因都是"多删了一个"。

对于 `A A` 模式（精确重复紧邻出现两次），**只删前一个 A，保留后一个 A**。

| 原文 | ❌ 错误：两个都删 | ✅ 正确：只删一个 |
|------|------------------|------------------|
| 蛮多的**蛮多的**这个信息 | 删"蛮多的蛮多的" → "这个信息" | 删"蛮多的" → "蛮多的这个信息" |
| 这条路**这条路**更适合我 | 删"这条路这条路" → "更适合我" | 删"这条路" → "这条路更适合我" |
| 一个一个一个新的技术 | 删全部"一个" → "新的技术" | 删两个 → "一个新的技术" |

**实现要点**：
1. 检测到 N 次连续重复时，`deleteCount = N - 1`（保留最后一个）
2. `deleteRange` = 从第一个 A 的 start 到倒数第二个 A 的 end（或最后一个 A 的 start）
3. 绝不能把最后一个副本也删掉
